{"version":3,"sources":["../src/presets.ts","../src/template.ts"],"sourcesContent":["/**\n * GuideScope Core - Presets\n * Japanese medical guideline search prompt generator\n */\n\nimport type { DifficultyPreset, TabPreset, DifficultyLevel } from './types';\n\n// ============================================================================\n// Difficulty Presets\n// ============================================================================\n\nexport const DIFFICULTY_PRESETS: DifficultyPreset[] = [\n  {\n    id: 'standard',\n    name: 'スタンダード',\n    description: '基本的な情報収集に最適',\n    features: [\n      '詳細サマリー',\n      '引用文献リスト',\n      '基本的な検索（10件まで）',\n    ],\n    settings: {\n      detailLevel: 'standard',\n      eGovCrossReference: false,\n      includeLawExcerpts: false,\n      recursiveDepth: 0,\n      maxResults: 10,\n      proofMode: false,\n    },\n  },\n  {\n    id: 'professional',\n    name: 'プロフェッショナル',\n    description: '詳細な分析と法令参照',\n    features: [\n      '冒頭サマリー',\n      'e-Gov法令クロスリファレンス',\n      '関連文書の再帰的取得（2階層）',\n      '詳細な条文抜粋',\n      '拡張検索（20件まで）',\n      '実証モード',\n    ],\n    settings: {\n      detailLevel: 'detailed',\n      eGovCrossReference: true,\n      includeLawExcerpts: true,\n      recursiveDepth: 2,\n      maxResults: 20,\n      proofMode: true,\n    },\n  },\n];\n\nexport function getDifficultyPreset(level: DifficultyLevel): DifficultyPreset {\n  return DIFFICULTY_PRESETS.find(p => p.id === level) || DIFFICULTY_PRESETS[0];\n}\n\n// ============================================================================\n// Tab Presets\n// ============================================================================\n\nexport const TAB_PRESETS: TabPreset[] = [\n  {\n    id: 'medical-device',\n    name: '医療機器開発寄り',\n    categories: [\n      '医療機器規制とSaMD、AI医療機器',\n      '臨床評価と性能評価',\n      '品質マネジメントとリスク管理',\n      '市販後と変更管理',\n      '横断的AIガバナンス',\n    ],\n    keywordChips: [\n      '医療AI ガイドライン 国内',\n      'AI 医療機器 ガイドライン',\n      'プログラムの医療機器該当性に関するガイドライン',\n      'SaMD 承認申請 手引き',\n      'PMDA プログラム医療機器 審査 手引き',\n    ],\n  },\n  {\n    id: 'clinical-operation',\n    name: '臨床運用寄り',\n    categories: [\n      '医療情報セキュリティ(3省2ガイドライン等)',\n      'クラウド利用と委託管理',\n      'アクセス制御と監査ログ',\n      '事故対応と継続運用',\n      '横断的AIガバナンス',\n    ],\n    keywordChips: [\n      '医療情報システムの安全管理に関するガイドライン',\n      '医療情報を取り扱う情報システム・サービスの提供事業者における安全管理ガイドライン',\n      '医療 生成AI 利用 ガイドライン',\n      '医療AI ガイドライン 国内',\n    ],\n  },\n  {\n    id: 'research-ethics',\n    name: '研究倫理寄り',\n    categories: [\n      '研究倫理',\n      '医療データ利活用と個人情報保護',\n      '同意と二次利用',\n      'データ管理と匿名化',\n      '横断的AIガバナンス',\n    ],\n    keywordChips: [\n      '医療デジタルデータ AI 研究開発 利活用 ガイドライン',\n      '医療AI 倫理 指針',\n      '人を対象とする生命科学・医学系研究に関する倫理指針',\n      '個人情報保護 医療 AI 仮名加工',\n    ],\n  },\n  {\n    id: 'generative-ai',\n    name: '生成AI寄り',\n    categories: [\n      '生成AIの利用',\n      '情報漏えいとデータ持ち出し',\n      '誤情報と説明責任',\n      '出力物の取扱い',\n      '横断的AIガバナンス',\n    ],\n    keywordChips: [\n      '医療 生成AI 利用 ガイドライン',\n      '生成AI 医療 文書 作成 支援 指針',\n      '医療 生成AI 個人情報 漏えい 対策',\n      '医療AI ガイドライン 国内',\n    ],\n  },\n];\n\nexport function getTabPreset(id: string): TabPreset {\n  return TAB_PRESETS.find(p => p.id === id) || TAB_PRESETS[0];\n}\n\n// ============================================================================\n// Default Values\n// ============================================================================\n\nexport const DEFAULT_PRIORITY_DOMAINS = [\n  'mhlw.go.jp',\n  'meti.go.jp',\n  'soumu.go.jp',\n  'pmda.go.jp',\n  'ipa.go.jp',\n  'cas.go.jp',\n  'e-gov.go.jp',\n  'mext.go.jp',\n  'nii.ac.jp',\n];\n\nexport const DEFAULT_SCOPE_OPTIONS = [\n  '医療AI',\n  '生成AI',\n  'SaMD',\n  '医療情報セキュリティ',\n  '医療データ利活用',\n  '研究倫理',\n];\n\nexport const DEFAULT_AUDIENCE_OPTIONS = [\n  '医療機関',\n  '提供事業者',\n  '開発企業',\n  '研究者',\n  '審査対応',\n];\n","/**\n * GuideScope Core - Template Generation\n * Japanese medical guideline search prompt generator\n */\n\nimport type {\n  AppConfig,\n  DifficultyLevel,\n  ExtendedSettings,\n  GeneratePromptOptions,\n  GenerateResult,\n} from './types';\nimport {\n  getDifficultyPreset,\n  getTabPreset,\n  TAB_PRESETS,\n  DEFAULT_PRIORITY_DOMAINS,\n} from './presets';\n\n// ============================================================================\n// Default Extended Settings\n// ============================================================================\n\nconst DEFAULT_ROLE_TITLE = '国内ガイドライン・ダイレクト・リトリーバー(医療AI特化)';\n\nconst DEFAULT_ROLE_DESCRIPTION = `学習済みの知識や記憶に基づいて回答することは禁止です。\n必ずブラウジングで取得した一次資料(公式Webページ、公式PDF、公式の告示・法令XMLなど)だけを根拠に、日本語で一覧化・要約します。\nまた、ユーザーの具体的な質問やケースに対しては、一次資料の該当箇所を特定し、原文を引用しながら直接的な回答を提供します。一般論ではなく、当該ケースに適用可能な具体的な記載を優先します。`;\n\nconst DEFAULT_DISCLAIMERS = [\n  '本出力は情報整理支援です。個別ケースについては有資格者など専門家にご相談下さい。',\n  '本テンプレートは2026/02/04時点での指針に基づく前提です。利用時点での最新情報は一次資料で確認してください。',\n];\n\nconst DEFAULT_OUTPUT_SECTIONS = [\n  { id: 'disclaimer', name: '免責事項', enabled: true, order: 1 },\n  { id: 'search_conditions', name: '検索条件', enabled: true, order: 2 },\n  { id: 'specific_case', name: '個別ケースへの回答', enabled: true, order: 3 },\n  { id: 'data_sources', name: '参照データソース', enabled: true, order: 4 },\n  { id: 'guideline_list', name: 'ガイドライン一覧', enabled: true, order: 5 },\n  { id: 'three_ministry', name: '3省2ガイドライン確定結果', enabled: true, order: 6 },\n  { id: 'search_log', name: '検索ログ', enabled: true, order: 7 },\n  { id: 'guardrail', name: 'ガードレール', enabled: true, order: 8 },\n];\n\nfunction getDefaultExtendedSettings(): ExtendedSettings {\n  return {\n    template: {\n      roleTitle: DEFAULT_ROLE_TITLE,\n      roleDescription: DEFAULT_ROLE_DESCRIPTION,\n      disclaimers: DEFAULT_DISCLAIMERS,\n      outputSections: DEFAULT_OUTPUT_SECTIONS,\n      customInstructions: '',\n    },\n    search: {\n      useSiteOperator: true,\n      useFiletypeOperator: true,\n      filetypes: ['pdf'],\n      priorityRule: 'revised_date',\n      excludedDomains: [],\n      maxResults: 20,\n      recursiveDepth: 2,\n    },\n    output: {\n      languageMode: 'japanese_only',\n      includeEnglishTerms: true,\n      detailLevel: 'standard',\n      eGovCrossReference: false,\n      includeLawExcerpts: true,\n      outputFormat: 'markdown',\n      includeSearchLog: true,\n    },\n  };\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\nfunction formatList(items: string[], prefix: string = '・'): string {\n  if (items.length === 0) return `${prefix}(なし)`;\n  return items.map(item => `${prefix}${item}`).join('\\n');\n}\n\nfunction getTodayDate(): string {\n  const today = new Date();\n  return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;\n}\n\n// ============================================================================\n// Config Creation\n// ============================================================================\n\nexport function createConfig(options: GeneratePromptOptions): AppConfig {\n  const preset = getTabPreset(options.preset || 'medical-device');\n  const date = options.date || getTodayDate();\n\n  return {\n    dateToday: date,\n    query: options.query,\n    scope: options.scope || ['医療AI'],\n    audiences: options.audiences || ['医療機関', '開発企業'],\n    difficultyLevel: options.difficulty || 'standard',\n\n    threeMinistryGuidelines: true,\n    officialDomainPriority: true,\n    siteOperator: true,\n    latestVersionPriority: true,\n    pdfDirectLink: true,\n    includeSearchLog: true,\n    eGovCrossReference: false,\n    proofMode: false,\n\n    categories: preset.categories.map(name => ({ name, enabled: true })),\n    keywordChips: preset.keywordChips.map(name => ({ name, enabled: true })),\n    customKeywords: options.customKeywords || [],\n    excludeKeywords: [],\n\n    priorityDomains: options.priorityDomains || [...DEFAULT_PRIORITY_DOMAINS],\n    activeTab: options.preset || 'medical-device',\n  };\n}\n\n// ============================================================================\n// Template Building\n// ============================================================================\n\nfunction buildBaseTemplate(extSettings: ExtendedSettings, difficultyLevel: DifficultyLevel): string {\n  const { template, output, search } = extSettings;\n\n  // Build Role section\n  const roleIntro = 'あなたは、内部知識を一切持たない「' + template.roleTitle + '」です。';\n  const cleanedDescription = template.roleDescription\n    .replace(/あなたは、内部知識を一切持たない「[^」]+」です。\\s*/g, '')\n    .trim();\n\n  const roleSection = '# Role\\n' + roleIntro + '\\n' + cleanedDescription;\n\n  // Build disclaimers section\n  const disclaimerSection = `# 注意\n${template.disclaimers.map(d => `- ${d}`).join('\\n')}`;\n\n  // Build proof section (conditionally included)\n  const proofSectionBegin = `PROOF_SECTION_BEGIN\n# 実証\n以下、実用に耐えうるか実証せよ。プロンプトの指示に従い一次資料を取得し、最後に実証結果として達成事項と制約事項を述べよ。\nPROOF_SECTION_END`;\n\n  // Build model definition\n  const modelDefinition = `# Model Definition\n\n## Variables\n$Date_today$: システムの現在日付(YYYY-MM-DD)\n$Query$: ユーザーの探索テーマ\n$SpecificQuestion$: ユーザーの具体的な質問やケース\n$Scope$: 対象範囲\n$Must_keywords$: 必須検索語\n$Optional_keywords$: 追加検索語\n$Candidate_docs$: 候補文書リスト\n$Doc_title$: 文書タイトル\n$Issuer$: 発行主体\n$Published_date$: 公開日\n$Revised_date$: 改定日\n$Version$: 版数\n$Doc_url$: 公式URL\n$Doc_type$: 文書種別\n$Fetched_text$: 取得した本文テキスト\n$RelevantSection$: 関連する本文箇所\n\n$Law_name$: 法令名\n$Law_ID$: e-Gov法令ID\n$U_xml$: e-Gov API URL\n$U_web$: e-Gov Web URL\n$Law_xml$: 取得したXML`;\n\n  // Build rules section\n  let rulesSection = `## Rules (Strict Logic)\n1. ゼロ知識\n   ・一次資料を取得する前に、内容を断定しない\n   ・一次資料に書かれていないことは「不明」とする\n   ・推測で補完しない\n\n2. 公式優先\n   ・候補発見のために一般サイトを使ってよいが、内容の根拠は必ず公式一次資料に限る\n   ・公式一次資料に到達できない場合は「公式資料未確認」と明記し、要約はしない\n   ・優先ドメイン:\n[[PRIORITY_DOMAINS_LIST]]`;\n\n  if (search.excludedDomains.length > 0) {\n    rulesSection += `\n   ・除外ドメイン:\n${search.excludedDomains.map(d => `     - ${d}`).join('\\n')}`;\n  }\n\n  rulesSection += `\n\n3. 個別ケースへの対応\n   ・$SpecificQuestion$ が与えられた場合、一般論ではなく当該ケースに直接適用可能な条文・記載を特定する\n   ・該当箇所は「○○ガイドライン 第X章 X.X節 pXX」のように具体的に引用する\n\n4. 版管理\n   ・同名文書が複数版ある場合、${search.priorityRule === 'revised_date' ? '改定日が最も新しい最新版' : search.priorityRule === 'published_date' ? '公開日が最も新しい版' : '関連度が最も高い版'}を特定して採用する\n\n5. 出力リンク形式\n   ・出力するURLは必ず Markdown の [表示ラベル](URL) 形式で提示する\n\n6. 再帰的参照\n   ・一次資料内に別の指針、通知、Q&A等が参照されている場合、リンクを辿って同様に取得する${search.recursiveDepth > 0 ? `（最大${search.recursiveDepth}階層まで）` : ''}\n\n7. 回答の具体性\n   ・一般論や抽象的な説明を避け、ユーザーの質問に直接答える\n   ・引用時は「○○ガイドライン 第X章 X.X節 pXX」のように出典を明記する`;\n\n  // e-Gov section\n  const eGovSection = `EGOV_SECTION_BEGIN\n8. e-Gov法令取得\n   ・文書内に法令が参照されている場合、e-Govで法令IDを特定し、APIで条文を取得する${output.includeLawExcerpts ? '\\n   ・該当条文の短い抜粋を含める' : ''}\n\n   API用: https://laws.e-gov.go.jp/api/2/law_data/{$Law_ID}?applicable_date={$Date_today}\n   Web用: https://laws.e-gov.go.jp/law/{$Law_ID}\nEGOV_SECTION_END`;\n\n  // Build task section\n  const taskSection = `# Task\n\n## Phase 1: 探索計画の確定\n1. ユーザー入力から $Query と $Scope を整理する\n2. $Must_keywords を確定する（3省2ガイドラインを必ず含める）\n3. $Optional_keywords を生成する\n4. ${search.useSiteOperator ? '優先ドメインに対して site: 指定も併用する' : '優先ドメインを参考に検索する'}\n\n## Phase 2: 候補文書の収集と一次資料取得\n1. 検索で見つかった候補を $Candidate_docs に記録する（最大${search.maxResults}件）\n2. 各候補について $Doc_url を開き、本文を取得する\n3. PDFの場合は本文を読み取り、関係する箇所を特定する\n\n## Phase 3: 必須テーマの確定\n1. 「3省2ガイドライン」を構成する文書を確定する\n2. 医療AIに関する他の国内ガイドラインも、最新版と根拠URLを確定する\n\n## Phase 4: 法令クロスリファレンス(必要時)\n1. 各文書で参照されている主要な法令名を抽出する\n2. e-Govで法令IDを特定し、該当条文を取得する\n\n## Phase 5: 個別ケース分析\n1. $Query$ を分解し、直接適用可能な記載を抽出する\n2. 該当箇所は原文を引用する`;\n\n  // Build output format section\n  const enabledSections = template.outputSections\n    .filter(s => s.enabled)\n    .sort((a, b) => a.order - b.order);\n\n  let outputFormatSection = `# Output Format\\n`;\n\n  if (difficultyLevel === 'standard') {\n    outputFormatSection += `\n■ サマリー\n・[[QUERY]]に関する結論と重要ポイントを5〜8点で整理する\n・$SpecificQuestion$ がある場合は結論を先に明記し、根拠箇所を併記する\n・各ポイントに「文書名 第X章 X.X節 pXX」を付記する\n・一次資料未確認の事項は明確に「未確認」とする\n\n■ 引用文献\n・参照した一次資料を文書単位で列挙する\n・形式: 文書名（発行主体、改定日） [公式ページ](URL) [PDF](URL)\n・法令は [XMLデータ(API)](U_xml) と [公式閲覧(e-Gov)](U_web)\n`;\n  } else {\n    outputFormatSection += `\n■ サマリー\n・結論と主要ポイントを3〜5点で簡潔に整理する\n・各ポイントに根拠文書名・章節・ページを併記する\n`;\n  }\n\n  for (const section of enabledSections) {\n    switch (section.id) {\n    case 'disclaimer':\n      outputFormatSection += `\n■ 免責\n・本出力は情報整理支援です。個別ケースについては専門家にご相談下さい。\n・本出力は[[DATE_TODAY]]時点の取得結果であり、更新があり得るため一次資料で確認すること。\n`;\n      break;\n    case 'search_conditions':\n      outputFormatSection += `\n■ 検索条件\n・日付: [[DATE_TODAY]]\n・テーマ: [[QUERY]]\n・範囲: [[SCOPE]]\n`;\n      break;\n    case 'data_sources':\n      outputFormatSection += `\n■ 参照データソース\n・各文書について [公式ページ](URL) と [PDF](URL) を列挙\n・法令は [XMLデータ(API)](U_xml) と [公式閲覧(e-Gov)](U_web)\n`;\n      break;\n    case 'guideline_list':\n      outputFormatSection += `\n■ ガイドライン一覧\nカテゴリ別に、各文書を整理する\n${output.detailLevel === 'concise' ? `・タイトル、発行主体、版数、公式URL` : output.detailLevel === 'detailed' ? `・タイトル、発行主体、文書種別、版数、対象者、医療AIとの関係、関連法令、実務上の重要ポイント` : `・タイトル、発行主体、文書種別、版数、対象者、医療AIとの関係、関連法令`}\n\nカテゴリ例\n[[CATEGORIES_LIST]]\n`;\n      break;\n    case 'three_ministry':\n      outputFormatSection += `\n■ 3省2ガイドラインの確定結果\n・構成文書の対応関係\n・対象者の違い\n・実務上の重要ポイント\n`;\n      break;\n    case 'specific_case':\n      outputFormatSection += `\n■ 個別ケースへの回答\n【直接適用可能な規制・ガイドライン】\n・根拠文書、該当箇所、原文抜粋、要約\n\n【複数解釈がある場合】\n・選択肢と根拠条文\n\n【明示的記載がない場合】\n・類似規定の参照と一般原則からの推論\n`;\n      break;\n    case 'search_log':\n      if (output.includeSearchLog) {\n        outputFormatSection += `\n■ 検索ログ\n・実際に使った検索語\n・参照した公式ドメイン一覧\n`;\n      }\n      break;\n    case 'guardrail':\n      outputFormatSection += `\n# Guardrail\n・一次資料を開けない場合は、その旨を明記して推測しない\n・出力リンクは必ず [表示ラベル](URL) 形式に統一する\n`;\n      break;\n    }\n  }\n\n  // Build input section\n  const inputSection = `# Input\nDate_today: [[DATE_TODAY]]\nQuery: [[QUERY]]\nSpecificQuestion: [[SPECIFIC_QUESTION]]\nScope: [[SCOPE]]\n\nAudiences:\n[[AUDIENCES_LIST]]\n\nPriorityDomains:\n[[PRIORITY_DOMAINS_LIST]]\n\nMust_keywords:\n[[MUST_KEYWORDS_LIST]]\n\nOptional_keywords:\n[[OPTIONAL_KEYWORDS_LIST]]\n\nExclude_keywords:\n[[EXCLUDE_KEYWORDS_LIST]]\n\nInstruction:\n次の条件で検索と整理を実行し、SpecificQuestion に対する具体的な回答を提供せよ。`;\n\n  // Build proof result section\n  const proofResultSection = `PROOF_SECTION_BEGIN\n# 実証結果\n本プロンプトが実用に耐えうるかを自己点検し、達成事項と制約事項を述べよ。\nPROOF_SECTION_END`;\n\n  // Custom instructions\n  const customInstructionsSection = template.customInstructions.trim()\n    ? `\\n# カスタム指示\\n${template.customInstructions}\\n`\n    : '';\n\n  return [\n    roleSection,\n    disclaimerSection,\n    proofSectionBegin,\n    modelDefinition,\n    rulesSection,\n    eGovSection,\n    taskSection,\n    outputFormatSection,\n    inputSection,\n    customInstructionsSection,\n    proofResultSection,\n  ].join('\\n\\n');\n}\n\n// ============================================================================\n// Main Generation Functions\n// ============================================================================\n\n/**\n * Generate a prompt from AppConfig\n */\nexport function generatePromptFromConfig(config: AppConfig, extSettings?: ExtendedSettings): string {\n  const settings = extSettings || getDefaultExtendedSettings();\n\n  // Get difficulty preset settings\n  const difficultyPreset = getDifficultyPreset(config.difficultyLevel);\n  const presetSettings = difficultyPreset.settings;\n\n  // Apply difficulty preset to settings\n  const isStandard = config.difficultyLevel === 'standard';\n  const adjustedSettings: ExtendedSettings = {\n    ...settings,\n    output: {\n      ...settings.output,\n      detailLevel: presetSettings.detailLevel,\n      eGovCrossReference: isStandard\n        ? presetSettings.eGovCrossReference\n        : (presetSettings.eGovCrossReference || config.eGovCrossReference),\n      includeLawExcerpts: presetSettings.includeLawExcerpts,\n    },\n    search: {\n      ...settings.search,\n      recursiveDepth: presetSettings.recursiveDepth,\n      maxResults: presetSettings.maxResults,\n    },\n  };\n\n  const effectiveConfig = {\n    ...config,\n    proofMode: isStandard ? presetSettings.proofMode : (presetSettings.proofMode || config.proofMode),\n  };\n\n  let prompt = buildBaseTemplate(adjustedSettings, config.difficultyLevel);\n\n  // Replace placeholders\n  prompt = prompt.replace(/\\[\\[DATE_TODAY\\]\\]/g, config.dateToday);\n  prompt = prompt.replace(/\\[\\[QUERY\\]\\]/g, config.query || '(未入力)');\n\n  const specificQuestion = config.query\n    ? `「${config.query}」について、適用可能な具体的な条文・記載を特定し、原文を引用して回答せよ`\n    : '(未入力)';\n  prompt = prompt.replace(/\\[\\[SPECIFIC_QUESTION\\]\\]/g, specificQuestion);\n\n  prompt = prompt.replace(/\\[\\[SCOPE\\]\\]/g, config.scope.join('、') || '(未指定)');\n  prompt = prompt.replace('[[AUDIENCES_LIST]]', formatList(config.audiences));\n  prompt = prompt.replace(/\\[\\[PRIORITY_DOMAINS_LIST\\]\\]/g, formatList(config.priorityDomains));\n\n  const mustKeywords = ['3省2ガイドライン'];\n  prompt = prompt.replace('[[MUST_KEYWORDS_LIST]]', formatList(mustKeywords));\n\n  const optionalKeywords = [\n    ...config.keywordChips.filter(k => k.enabled).map(k => k.name),\n    ...config.customKeywords.filter(k => k.trim()),\n  ];\n  prompt = prompt.replace(/\\[\\[OPTIONAL_KEYWORDS_LIST\\]\\]/g, formatList(optionalKeywords));\n  prompt = prompt.replace('[[EXCLUDE_KEYWORDS_LIST]]', formatList(config.excludeKeywords.filter(k => k.trim())));\n\n  const enabledCategories = config.categories.filter(c => c.enabled).map(c => c.name);\n  prompt = prompt.replace('[[CATEGORIES_LIST]]', formatList(enabledCategories));\n\n  // Handle e-Gov section\n  if (!adjustedSettings.output.eGovCrossReference) {\n    prompt = prompt.replace(/EGOV_SECTION_BEGIN[\\s\\S]*?EGOV_SECTION_END/g, '');\n  } else {\n    prompt = prompt.replace(/EGOV_SECTION_BEGIN\\n?/g, '');\n    prompt = prompt.replace(/EGOV_SECTION_END\\n?/g, '');\n  }\n\n  // Handle proof section\n  if (!effectiveConfig.proofMode) {\n    prompt = prompt.replace(/PROOF_SECTION_BEGIN[\\s\\S]*?PROOF_SECTION_END/g, '');\n  } else {\n    prompt = prompt.replace(/PROOF_SECTION_BEGIN\\n?/g, '');\n    prompt = prompt.replace(/PROOF_SECTION_END\\n?/g, '');\n  }\n\n  // Clean up\n  prompt = prompt.replace(/\\n{3,}/g, '\\n\\n');\n\n  return prompt.trim();\n}\n\n/**\n * Generate search queries from AppConfig\n */\nexport function generateSearchQueriesFromConfig(config: AppConfig, extSettings?: ExtendedSettings): string[] {\n  const settings = extSettings || getDefaultExtendedSettings();\n  const queries: string[] = [];\n\n  // 1. Query with 3省2ガイドライン\n  queries.push(`3省2ガイドライン ${config.query || '医療AI'} ガイドライン 最新版`);\n\n  // 2. Query with user's search theme\n  if (config.query) {\n    queries.push(`${config.query} ガイドライン 国内`);\n  }\n\n  // 3. Top 5 enabled keyword chips\n  const enabledChips = config.keywordChips.filter(k => k.enabled).slice(0, 5);\n  enabledChips.forEach(chip => {\n    queries.push(chip.name);\n  });\n\n  // 4. Site-specific queries\n  if (config.officialDomainPriority && settings.search.useSiteOperator) {\n    const topDomains = config.priorityDomains.slice(0, 3);\n    topDomains.forEach(domain => {\n      queries.push(`site:${domain} ${config.query || '医療AI'} ガイドライン`);\n    });\n  }\n\n  // 5. Filetype-specific queries\n  if (settings.search.useFiletypeOperator && settings.search.filetypes.length > 0) {\n    const filetypeQuery = settings.search.filetypes.map(ft => `filetype:${ft}`).join(' OR ');\n    queries.push(`${config.query || '医療AI'} ガイドライン (${filetypeQuery})`);\n  }\n\n  return queries.slice(0, Math.min(10, settings.search.maxResults));\n}\n\n// ============================================================================\n// Simplified API\n// ============================================================================\n\n/**\n * Generate prompt and search queries from simple options\n *\n * @example\n * ```typescript\n * const result = generate({\n *   query: '医療AIの臨床導入における安全管理',\n *   preset: 'clinical-operation',\n *   difficulty: 'professional',\n * });\n *\n * console.log(result.prompt);\n * console.log(result.searchQueries);\n * ```\n */\nexport function generate(options: GeneratePromptOptions): GenerateResult {\n  const config = createConfig(options);\n  const prompt = generatePromptFromConfig(config);\n  const searchQueries = generateSearchQueriesFromConfig(config);\n\n  return {\n    prompt,\n    searchQueries,\n    config,\n  };\n}\n\n/**\n * Generate prompt only\n */\nexport function generatePrompt(options: GeneratePromptOptions): string {\n  const config = createConfig(options);\n  return generatePromptFromConfig(config);\n}\n\n/**\n * Generate search queries only\n */\nexport function generateSearchQueries(options: GeneratePromptOptions): string[] {\n  const config = createConfig(options);\n  return generateSearchQueriesFromConfig(config);\n}\n"],"mappings":"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","names":[]}